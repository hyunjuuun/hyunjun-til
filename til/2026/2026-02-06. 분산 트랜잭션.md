# 분산 트랜잭션은 왜 단일 트랜잭션처럼 처리할 수 없을까?

## 배경 (정리 목적)

단일 애플리케이션 + 단일 데이터베이스 환경에서는  
트랜잭션을 `BEGIN → COMMIT / ROLLBACK` 으로 단순하게 다룰 수 있다.

하지만 서비스가 분리되고(주문, 결제, 재고 등),  
각 서비스가 **자신만의 DB를 가지는 구조**로 바뀌는 순간  
“이 작업들을 하나의 트랜잭션으로 묶을 수 있을까?”라는 문제가 발생한다.


---

## 핵심 내용

### 1. 분산 트랜잭션이란 무엇인가

분산 트랜잭션은  
**여러 서비스(또는 여러 DB)에 걸친 작업을 하나의 논리적 작업처럼 다루려는 시도**다.

예를 들어 주문 시스템을 단순화하면 다음과 같다.

1. 주문 생성 (Order Service)
2. 결제 처리 (Payment Service)
3. 재고 차감 (Inventory Service)

단일 DB라면 하나의 트랜잭션으로 묶을 수 있지만,  
각 서비스가 독립적인 DB를 가진다면 **물리적으로 하나의 트랜잭션을 공유할 수 없다.**

이 지점에서 기존의 ACID 트랜잭션 모델이 깨진다.

---

### 2. 2PC (Two-Phase Commit): 분산 환경에서도 트랜잭션을 만들려는 시도

2PC는 분산 트랜잭션을 **DB 트랜잭션과 최대한 유사하게** 만들기 위한 방식이다.

#### 동작 개요
1. **Prepare 단계**
  - 코디네이터가 모든 참여자에게 “커밋 가능?”을 묻는다
  - 각 참여자는 로컬 트랜잭션을 준비 상태로 둔다 (락 유지)
2. **Commit 단계**
  - 모두 OK → 전체 커밋
  - 하나라도 실패 → 전체 롤백

#### 왜 문제가 되는가
- 모든 참여자가 **락을 잡고 대기**한다
- 중간에 코디네이터가 장애 나면 참여자들은 결정 불가 상태에 빠진다
- 네트워크 지연, 장애에 매우 취약하다

#### 언제 고려되는가
- 강한 일관성이 절대적으로 필요한 경우
- 참여 시스템 수가 매우 적고, 통제 가능한 환경

실무 MSA 환경에서는 거의 선택되지 않는다

---

### 3. SAGA: 트랜잭션을 포기하고 흐름을 관리한다

SAGA는 관점을 완전히 바꾼다.

> “하나의 트랜잭션처럼 만들 수 없다면  
> 여러 개의 로컬 트랜잭션과 보상 작업으로 관리하자”

#### 핵심 아이디어
- 각 서비스는 **자신의 로컬 트랜잭션만 책임진다**
- 실패 시 롤백이 아니라 **보상 트랜잭션**을 실행한다

#### 주문 예시
1. 주문 생성 (성공)
2. 결제 처리 (실패)
3. 주문 취소 (보상 트랜잭션)

이미 커밋된 작업을 되돌리는 대신  
**취소 / 환불 / 상태 변경** 같은 비즈니스 행위로 복구한다.

---

### 4. SAGA 구현 방식: Orchestration vs Choreography

#### Orchestration 방식
- 중앙 오케스트레이터가 흐름을 제어
- 각 단계 성공/실패에 따라 다음 액션을 명시적으로 호출

장점:
- 흐름이 명확하다
- 디버깅과 가시성이 좋다

단점:
- 오케스트레이터가 비대해질 수 있다

#### Choreography 방식
- 이벤트 기반으로 각 서비스가 반응
- 중앙 제어자는 없다

장점:
- 서비스 간 결합도가 낮다
- 확장에 유리하다

단점:
- 전체 흐름을 파악하기 어렵다
- 디버깅 난이도가 높다

---

### 5. 결국 무엇을 선택해야 하는가

중요한 포인트는  
**“분산 트랜잭션을 구현한다” = “일관성을 어떻게 포기할지 결정한다”** 는 점이다.

- 2PC: 강한 일관성, 낮은 가용성
- SAGA: 최종적 일관성, 높은 가용성

대부분의 MSA 시스템은  
**SAGA + 상태 머신 + 재시도/보상 전략**을 선택한다.

---

## 정리

- 분산 환경에서는 단일 트랜잭션 모델이 깨진다
- 2PC는 이론적으로 가능하지만 실무에서는 제약이 크다
- SAGA는 현실적인 선택이며, 보상 트랜잭션 설계가 핵심이다

다음으로는  
**주문 상태 머신을 어떻게 설계해야 SAGA와 잘 맞는지**,  
그리고 **API 호출과 이벤트 중 어떤 통신 방식을 선택해야 하는지**를 더 살펴보면 좋겠다.